<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­èƒŒè¯æ‰“å¡ç³»ç»Ÿ</title>
<style>
body{font-family:Arial;padding:20px;max-width:900px;margin:auto}
button,input,select{padding:10px;margin:6px;font-size:16px}
.word{font-size:28px;font-weight:bold;color:#2c3e50;cursor:pointer}
.example{color:#555;margin-top:5px;cursor:pointer}
.card{border:1px solid #ddd;padding:15px;border-radius:10px;margin-top:15px}
.info{color:#666;margin-top:10px}
canvas{position:fixed;left:0;top:0;pointer-events:none}
.modebar button{border:1px solid #ccc;border-radius:6px;background:#f8f8f8}
</style>
</head>
<body>

<h1>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</h1>

<label>æ¯æ—¥å•è¯æ•°ï¼š</label>
<input type="number" id="dailyCount" value="10" min="10">

<label>é¡ºåºï¼š</label>
<select id="orderMode">
  <option value="fixed">å›ºå®šé¡ºåº</option>
  <option value="random">éšæœºé¡ºåº</option>
</select>

<label>å‘éŸ³ï¼š</label>
<select id="voiceType">
  <option value="en-US">ç¾å¼</option>
  <option value="en-GB">è‹±å¼</option>
</select>

<div class="modebar">
  <button onclick="setMode('view')">ğŸ“– æµè§ˆæ¨¡å¼</button>
  <button onclick="setMode('spell')">âœ æ‹¼å†™æ¨¡å¼</button>
</div>

<button onclick="start()">å¼€å§‹ä»Šæ—¥æ‰“å¡</button>

<div id="card" class="card"></div>
<div id="progress" class="info"></div>
<div id="record" class="info"></div>

<canvas id="fireworks"></canvas>

<script>
// ====== é…ç½® ======
const CACHE_KEY="WORD_CACHE_V4";
const RECORD_KEY="PUNCH_RECORD";
const WORD_URL="https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-no-swears.txt";

let cet4=[],cet6=[];
let mode="view";
let todayList=[],index=0;

// ====== è·å–çœŸå®ç¿»è¯‘ + ä¾‹å¥ ======
async function getWordDetail(word){
  let result = {
    cn: "æš‚æ— ä¸­æ–‡ç¿»è¯‘",
    en: `This is an example for ${word}.`,
    cnEx: `è¿™æ˜¯ä¸€ä¸ªå…³äº ${word} çš„ä¾‹å¥ã€‚`
  };

  try{
    // è‹±æ–‡è¯å…¸
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data = await res.json();
    const def = data[0]?.meanings?.[0]?.definitions?.[0];

    if(def?.example) result.en = def.example;
  }catch(e){}

  try{
    // ä¸­æ–‡ç¿»è¯‘
    const res2 = await fetch(`https://api.mymemory.translated.net/get?q=${word}&langpair=en|zh`);
    const data2 = await res2.json();
    result.cn = data2?.responseData?.translatedText || result.cn;
  }catch(e){}

  try{
    // ä¾‹å¥ç¿»è¯‘æˆä¸­æ–‡
    const res3 = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(result.en)}&langpair=en|zh`);
    const data3 = await res3.json();
    result.cnEx = data3?.responseData?.translatedText || result.cnEx;
  }catch(e){}

  return result;
}

// ====== æ¨¡å¼åˆ‡æ¢ ======
function setMode(m){mode=m;showWord();}

// ====== åŠ è½½è¯åº“ ======
async function loadWords(){
  if(localStorage.getItem(CACHE_KEY)){
    let d=JSON.parse(localStorage.getItem(CACHE_KEY));
    cet4=d.cet4; cet6=d.cet6; return;
  }

  const res=await fetch(WORD_URL);
  const txt=await res.text();
  const all=txt.split("\n").filter(x=>x.trim());

  cet4 = all.slice(0,3000).map(w=>({w}));
  cet6 = all.slice(3000,6000).map(w=>({w}));

  localStorage.setItem(CACHE_KEY,JSON.stringify({cet4,cet6}));
}
loadWords();

// ====== æœ—è¯» ======
function speak(t){
  let u=new SpeechSynthesisUtterance(t);
  u.lang=document.getElementById("voiceType").value;
  speechSynthesis.speak(u);
}

// ====== å¼€å§‹ ======
function start(){
  let n=parseInt(document.getElementById("dailyCount").value);
  let order=document.getElementById("orderMode").value;
  let pool=[...cet4,...cet6];
  if(order==="random") pool.sort(()=>Math.random()-0.5);
  todayList=pool.slice(0,n);
  index=0;
  showWord();
}

// ====== æŒ–ç©º ======
function maskWord(w){
  let a=w.split(""); 
  let c=Math.max(1,Math.floor(w.length/3));
  let s=new Set();
  while(s.size<c) s.add(Math.floor(Math.random()*w.length));
  s.forEach(i=>a[i]="_");
  return a.join("");
}

// ====== æ˜¾ç¤º ======
async function showWord(){
  let box=document.getElementById("card");
  if(!todayList.length) return;

  if(index>=todayList.length){
    completePunch();
    return;
  }

  let w=todayList[index];
  box.innerHTML="æ­£åœ¨åŠ è½½å•è¯è¯¦æƒ…...";

  const detail = await getWordDetail(w.w);

  if(mode==="view"){
    box.innerHTML=`
      <div class="word" onclick="speak('${w.w}')">${w.w}</div>
      <div>ä¸­æ–‡ï¼š${detail.cn}</div>
      <div class="example" onclick="speak('${detail.en}')">${detail.en}<br>${detail.cnEx}</div>
      <button onclick="nextWord()">ä¸‹ä¸€ä¸ª</button>
    `;
  }else{
    box.innerHTML=`
      <div class="word">${maskWord(w.w)}</div>
      <div>ä¸­æ–‡ï¼š${detail.cn}</div>
      <div class="example" onclick="speak('${detail.en}')">${detail.en}<br>${detail.cnEx}</div>
      <input id="spellInput" placeholder="è¾“å…¥å®Œæ•´å•è¯">
      <button onclick="checkSpell()">æäº¤</button>
    `;
  }

  document.getElementById("progress").innerText=`è¿›åº¦ï¼š${index+1} / ${todayList.length}`;
}

// ====== ä¸‹ä¸€é¢˜ ======
function nextWord(){index++;showWord();}
function checkSpell(){
  let user=document.getElementById("spellInput").value.trim().toLowerCase();
  let cor=todayList[index].w.toLowerCase();
  alert(user===cor?"âœ… æ­£ç¡®":"âŒ æ­£ç¡®ä¸ºï¼š"+cor);
  index++;showWord();
}

// ====== æ‰“å¡å®Œæˆè®°å½• + çƒŸèŠ± ======
function completePunch(){
  let now=new Date();
  let dateStr=now.toLocaleDateString();
  let timeStr=now.toLocaleTimeString();

  let rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  rec.push({date:dateStr,time:timeStr});
  localStorage.setItem(RECORD_KEY,JSON.stringify(rec));

  document.getElementById("card").innerHTML="ğŸ‰ ä»Šæ—¥æ‰“å¡å®Œæˆï¼";
  document.getElementById("progress").innerText=`ç´¯è®¡æ‰“å¡ï¼š${rec.length} å¤©`;
  showRecord();
  firework();
}

// ====== æ˜¾ç¤ºè®°å½• ======
function showRecord(){
  let rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  let html="ğŸ“ æ‰“å¡è®°å½•ï¼š<br>";
  rec.slice(-5).reverse().forEach(r=>{
    html+=`${r.date} ${r.time}<br>`;
  });
  document.getElementById("record").innerHTML=html;
}
showRecord();

// ====== ç®€æ˜“çƒŸèŠ±åŠ¨ç”» ======
function firework(){
  let c=document.getElementById("fireworks");
  let ctx=c.getContext("2d");
  c.width=window.innerWidth;
  c.height=window.innerHeight;
  let parts=[];
  for(let i=0;i<80;i++){
    parts.push({
      x:c.width/2,y:c.height/2,
      vx:(Math.random()-0.5)*6,
      vy:(Math.random()-0.5)*6,
      life:60
    });
  }

  let timer=setInterval(()=>{
    ctx.clearRect(0,0,c.width,c.height);
    parts.forEach(p=>{
      ctx.fillStyle=`hsl(${Math.random()*360},100%,60%)`;
      ctx.beginPath();
      ctx.arc(p.x,p.y,3,0,Math.PI*2);
      ctx.fill();
      p.x+=p.vx;
      p.y+=p.vy;
      p.life--;
    });
    parts=parts.filter(p=>p.life>0);
    if(parts.length===0) clearInterval(timer);
  },30);
}
</script>
</body>
</html>
